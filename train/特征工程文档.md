# 中国房地产需求预测 - 特征工程文档

## 目录
1. [概述](#概述)
2. [数据源](#数据源)
3. [特征类型](#特征类型)
4. [特征工程流程](#特征工程流程)
5. [特征选择](#特征选择)
6. [缺失值处理](#缺失值处理)
7. [使用说明](#使用说明)

---

## 概述

本特征工程系统旨在为中国房地产需求预测任务构建高质量的特征集。通过整合多个数据源，创建了涵盖时间、空间、市场、经济等多个维度的特征，为机器学习模型提供丰富的输入信息。

### 主要特点
- **多数据源融合**：整合9个不同的数据源
- **时间序列特征**：充分利用历史信息
- **空间特征**：捕捉区域间相关性
- **市场特征**：反映市场情绪和趋势
- **智能特征选择**：多方法融合的特征重要性评估

---

## 数据源

### 1. 核心数据
- **new_house_transactions.csv**: 新房交易数据（主要目标数据）
  - 包含：交易金额、价格、面积、数量、可售面积等

### 2. 辅助数据
- **land_transactions.csv**: 土地交易数据
  - 包含：土地交易金额、建筑面积、规划建筑面积等
  - 作用：预测未来新房供应

- **pre_owned_house_transactions.csv**: 二手房交易数据
  - 包含：二手房交易金额、价格、面积等
  - 作用：反映市场整体活跃度

### 3. 空间数据
- **sector_POI.csv**: 区域兴趣点数据
  - 包含：人口、商业、交通、教育、医疗等配套设施信息

- **new_house_transactions_nearby_sectors.csv**: 邻近区域新房交易数据
- **pre_owned_house_transactions_nearby_sectors.csv**: 邻近区域二手房交易数据
- **land_transactions_nearby_sectors.csv**: 邻近区域土地交易数据
  - 作用：捕捉空间相关性

### 4. 宏观数据
- **city_indexes.csv**: 城市指标数据
  - 包含：GDP、人口、收入、财政等宏观经济指标

- **city_search_index.csv**: 城市搜索指数数据
  - 包含：不同关键词和来源的搜索量
  - 作用：反映市场关注度和需求

---

## 特征类型

### 1. 时间特征 (Temporal Features)

#### 1.1 基础时间特征
- `year`: 年份
- `month_num`: 月份（1-12）
- `quarter`: 季度（1-4）
- `day_of_year`: 一年中的第几天
- `week_of_year`: 一年中的第几周
- `is_month_start`: 是否为月初
- `is_month_end`: 是否为月末

#### 1.2 季节性特征
- `is_spring`: 是否为春季（3-5月）
- `is_summer`: 是否为夏季（6-8月）
- `is_autumn`: 是否为秋季（9-11月）
- `is_winter`: 是否为冬季（12-2月）
- `is_holiday_month`: 是否为节假日月份（1、2、10月）

#### 1.3 周期性特征
- `month_sin`, `month_cos`: 月份的周期性编码（12个月周期）
- `quarter_sin`, `quarter_cos`: 季度的周期性编码（4个季度周期）
- `year_sin`, `year_cos`: 年份的周期性编码（6年周期）

#### 1.4 趋势特征
- `time_index`: 时间索引（从2019年1月开始）
- `time_index_squared`: 时间索引的平方（捕捉非线性趋势）

**特征数量**: 约 15 个

---

### 2. 滞后特征 (Lag Features)

#### 2.1 滞后值特征
对以下特征创建滞后值（lag periods: 1, 2, 3, 6, 12, 24个月）：
- `amount_new_house_transactions`: 新房交易金额
- `price_new_house_transactions`: 新房价格
- `area_new_house_transactions`: 新房交易面积
- `num_new_house_transactions`: 新房交易数量

**示例**: `amount_new_house_transactions_lag_1`, `amount_new_house_transactions_lag_12`

#### 2.2 移动统计特征
对每个特征创建移动窗口统计量（窗口: 3, 6, 12, 24个月）：
- **均值** (MA): `{feature}_ma_{period}`
- **标准差** (STD): `{feature}_std_{period}`
- **最小值** (MIN): `{feature}_min_{period}`
- **最大值** (MAX): `{feature}_max_{period}`
- **中位数** (MEDIAN): `{feature}_median_{period}`

**示例**: `amount_new_house_transactions_ma_6`, `price_new_house_transactions_std_12`

#### 2.3 增长率特征
- `{feature}_growth_rate`: 月度增长率（环比）
- `{feature}_mom_growth`: 月度增长率（Month-over-Month）
- `{feature}_qoq_growth`: 季度增长率（Quarter-over-Quarter）
- `{feature}_yoy_growth`: 年度增长率（Year-over-Year）

#### 2.4 趋势特征
- `{feature}_acceleration`: 加速度（增长率的变化率）

#### 2.5 相对位置特征
- `{feature}_percentile_{period}`: 当前值在历史窗口中的分位数位置（窗口: 6, 12个月）

**特征数量**: 约 100+ 个

---

### 3. 比率特征 (Ratio Features)

#### 3.1 价格相关比率
- `price_per_area`: 单位面积价格
- `amount_per_transaction`: 单笔交易金额
- `area_per_transaction`: 单笔交易面积

#### 3.2 供需比率
- `supply_demand_ratio`: 供需比（可售面积 / 交易面积）
- `sell_through_rate`: 去化率（1 / 去化周期）

#### 3.3 波动率特征
- `price_volatility`: 价格波动率（6个月滚动标准差）

**特征数量**: 约 6 个

---

### 4. 区域特征 (Sector Features)

#### 4.1 人口密度特征
- `population_density`: 人口密度（总人口 / 区域面积）
- `resident_density`: 常住人口密度

#### 4.2 商业密度特征
- `commercial_density`: 商业密度（商业面积 / 区域面积）
- `shop_density`: 商店密度（商店数量 / 区域面积）

#### 4.3 交通便利性特征
- `transportation_score`: 交通便利性得分（公交站 + 地铁站×2）
- `transportation_density`: 交通密度

#### 4.4 教育配套特征
- `education_score`: 教育配套得分（加权计算）
- `education_density`: 教育密度

#### 4.5 医疗配套特征
- `medical_score`: 医疗配套得分（加权计算）
- `medical_density`: 医疗密度

#### 4.6 价格吸引力
- `price_attractiveness`: 价格吸引力（周边平均房价 / 本区域房价）

**特征数量**: 约 10 个

---

### 5. 市场特征 (Market Features)

#### 5.1 搜索指数特征
从 `city_search_index.csv` 中提取：
- 不同关键词和来源的搜索量特征
- `search_{keyword}_{source}`: 特定关键词和来源的搜索量

#### 5.2 搜索指数聚合特征
- `total_search_volume`: 总搜索量
- `avg_search_volume`: 平均搜索量
- `search_volatility`: 搜索量波动率

#### 5.3 特定主题搜索
- `buy_house_search`: 买房相关搜索总量
- `price_search`: 房价相关搜索总量

**特征数量**: 约 10-20 个（取决于搜索关键词数量）

---

### 6. 经济特征 (Economic Features)

#### 6.1 GDP相关特征
- `gdp_per_capita_ratio`: 人均GDP比率
- `gdp_growth_rate`: GDP增长率

#### 6.2 人口相关特征
- `population_growth_rate`: 人口增长率
- `urbanization_rate`: 城镇化率

#### 6.3 收入相关特征
- `income_growth_rate`: 收入增长率
- `wage_income_ratio`: 工资收入比

#### 6.4 财政相关特征
- `fiscal_balance`: 财政收支平衡
- `fiscal_balance_ratio`: 财政收支比率

**特征数量**: 约 8 个

---

### 7. 土地交易特征 (Land Transaction Features)

#### 7.1 土地交易滞后特征
对以下特征创建滞后值（lag periods: 3, 6, 12, 18, 24个月）：
- `transaction_amount`: 土地交易金额
- `construction_area`: 建筑面积
- `planned_building_area`: 规划建筑面积
- `num_land_transactions`: 土地交易数量

**注意**: 土地交易通常需要较长时间才能转化为新房供应，因此使用较长的滞后期。

#### 7.2 土地交易移动统计
- `{feature}_ma_{period}`: 移动平均（窗口: 6, 12, 24个月）
- `{feature}_sum_{period}`: 移动求和

#### 7.3 土地与新房的比率
- `land_new_house_ratio`: 土地交易金额 / 新房交易金额
- `land_price_per_area`: 土地单价

**特征数量**: 约 30+ 个

---

### 8. 二手房交易特征 (Pre-owned House Features)

#### 8.1 二手房滞后特征
对以下特征创建滞后值（lag periods: 1, 2, 3, 6, 12个月）：
- `amount_pre_owned_house_transactions`: 二手房交易金额
- `price_pre_owned_house_transactions`: 二手房价格
- `area_pre_owned_house_transactions`: 二手房交易面积
- `num_pre_owned_house_transactions`: 二手房交易数量

#### 8.2 二手房移动平均
- `{feature}_ma_{period}`: 移动平均（窗口: 3, 6, 12个月）

#### 8.3 新房与二手房比率
- `new_pre_owned_price_ratio`: 新房价格 / 二手房价格
- `new_pre_owned_amount_ratio`: 新房交易金额 / 二手房交易金额
- `new_pre_owned_area_ratio`: 新房交易面积 / 二手房交易面积

**特征数量**: 约 30+ 个

---

### 9. 邻近区域特征 (Nearby Sector Features)

#### 9.1 邻近区域新房交易特征
对以下特征创建滞后和移动平均：
- `amount_new_house_transactions_nearby_sectors`: 邻近区域新房交易金额
- `price_new_house_transactions_nearby_sectors`: 邻近区域新房价格
- `area_new_house_transactions_nearby_sectors`: 邻近区域新房交易面积

#### 9.2 邻近区域二手房交易特征
- `amount_pre_owned_house_transactions_nearby_sectors`: 邻近区域二手房交易金额
- `price_pre_owned_house_transactions_nearby_sectors`: 邻近区域二手房价格

#### 9.3 本区域与邻近区域比率
- `local_nearby_amount_ratio`: 本区域交易金额 / 邻近区域交易金额
- `local_nearby_price_ratio`: 本区域价格 / 邻近区域价格
- `local_nearby_area_ratio`: 本区域交易面积 / 邻近区域交易面积

**特征数量**: 约 20+ 个

---

### 10. 交互特征 (Interaction Features)

#### 10.1 价格与面积交互
- `price_area_interaction`: 价格 × 面积
- `price_area_ratio_squared`: (价格/面积)²

#### 10.2 人口交互
- `population_price_interaction`: 人口 × 价格
- `population_area_interaction`: 人口 × 面积

#### 10.3 搜索量交互
- `search_price_interaction`: 搜索量 × 价格
- `search_amount_interaction`: 搜索量 × 交易金额

#### 10.4 供需交互
- `supply_price_interaction`: 供需比 × 价格
- `supply_amount_interaction`: 供需比 × 交易金额

#### 10.5 新房与二手房交互
- `new_pre_owned_price_diff`: 新房价格 - 二手房价格
- `new_pre_owned_price_product`: 新房价格 × 二手房价格

#### 10.6 邻近区域交互
- `local_nearby_amount_diff`: 本区域交易金额 - 邻近区域交易金额
- `local_nearby_price_diff`: 本区域价格 - 邻近区域价格

**特征数量**: 约 15 个

---

## 特征工程流程

### 完整流程

```
1. 数据加载 (load_data)
   ├── 加载所有9个数据源
   └── 统一时间格式

2. 时间特征创建 (create_temporal_features)
   └── 创建基础时间、季节性、周期性特征

3. 滞后特征创建 (create_lag_features)
   └── 创建滞后值、移动统计、增长率等特征

4. 比率特征创建 (create_ratio_features)
   └── 创建价格、供需、波动率等比率特征

5. 区域特征创建 (create_sector_features)
   └── 合并POI数据，创建区域特征

6. 市场特征创建 (create_market_features)
   └── 合并搜索指数数据，创建市场特征

7. 经济特征创建 (create_economic_features)
   └── 合并城市指标数据，创建经济特征

8. 土地交易特征创建 (create_land_transaction_features)
   └── 合并土地交易数据，创建土地相关特征

9. 二手房交易特征创建 (create_pre_owned_house_features)
   └── 合并二手房数据，创建二手房相关特征

10. 邻近区域特征创建 (create_nearby_sector_features)
    └── 合并邻近区域数据，创建空间相关特征

11. 交互特征创建 (create_interaction_features)
    └── 创建特征间的交互项

12. 缺失值处理 (handle_missing_values)
    └── 智能填充缺失值

13. 特征选择 (feature_selection)
    └── 多方法融合的特征重要性评估

14. 创建最终数据集 (create_final_dataset)
    └── 保存处理后的数据集
```

---

## 特征选择

### 方法概述

采用**多方法融合**的特征选择策略，结合三种不同的特征重要性评估方法：

#### 1. 随机森林特征重要性 (Random Forest Importance)
- **权重**: 50%
- **原理**: 基于树的特征重要性，捕捉非线性关系
- **优点**: 对非线性关系敏感，稳定性好

#### 2. F统计量 (F-statistic)
- **权重**: 30%
- **原理**: 基于线性回归的F检验
- **优点**: 捕捉线性相关性，计算快速

#### 3. 互信息 (Mutual Information)
- **权重**: 20%
- **原理**: 基于信息论的特征相关性
- **优点**: 捕捉非线性相关性，无需假设分布

### 选择策略

1. **归一化**: 将三种方法的得分归一化到[0,1]区间
2. **综合得分**: 计算加权平均得分
   ```
   combined_score = 0.5 × RF_norm + 0.3 × F_norm + 0.2 × MI_norm
   ```
3. **阈值选择**: 
   - 动态阈值：选择综合得分 > max(0.01, 30%分位数)的特征
   - 最小保证：至少选择前50个特征

### 输出

- 特征重要性排序表
- 前30个最重要特征的详细信息
- 最终选择的特征列表

---

## 缺失值处理

### 处理策略

采用**分层填充**策略，根据特征类型选择不同的填充方法：

#### 1. 时间序列特征
对于包含 `lag`, `ma`, `growth`, `percentile` 等关键词的特征：
1. **前向填充** (Forward Fill): 按区域分组，使用前一个值填充
2. **后向填充** (Backward Fill): 按区域分组，使用后一个值填充
3. **中位数填充**: 如果仍有缺失，使用全局中位数填充

#### 2. 其他数值特征
1. **组内中位数填充**: 按区域分组，使用组内中位数填充
2. **全局中位数填充**: 如果仍有缺失，使用全局中位数填充

#### 3. 分类特征
- 使用众数填充

### 优势

- **保持时间序列连续性**: 时间序列特征优先使用前向/后向填充
- **保持区域一致性**: 按区域分组处理，避免跨区域污染
- **鲁棒性**: 多层填充策略确保所有缺失值都被处理

---

## 使用说明

### 基本使用

```python
from feature_engineering import FeatureEngineer

# 创建特征工程器实例
engineer = FeatureEngineer(data_path='./train')

# 运行完整的特征工程流程
final_df, selected_features, feature_importance = engineer.run_feature_engineering()
```

### 输出文件

1. **final_dataset.csv**: 最终处理后的数据集
   - 包含：月份、区域、选定的特征、目标变量

2. **特征重要性信息**: 在控制台输出
   - 前30个最重要特征的详细信息
   - 最终选择的特征数量

### 参数说明

- `data_path`: 数据文件路径（默认为当前目录）
  - 应包含 `train/` 子目录，其中包含所有CSV数据文件

### 自定义使用

如果需要单独使用某个特征创建方法：

```python
engineer = FeatureEngineer()
engineer.load_data()

# 单独创建时间特征
engineer.create_temporal_features()

# 单独创建滞后特征
engineer.create_lag_features()

# 访问处理后的数据
df = engineer.data['new_house_transactions']
```

---

## 特征统计

### 特征数量统计

| 特征类型 | 数量 | 说明 |
|---------|------|------|
| 时间特征 | ~15 | 基础时间、季节性、周期性特征 |
| 滞后特征 | ~100+ | 滞后值、移动统计、增长率等 |
| 比率特征 | ~6 | 价格、供需、波动率比率 |
| 区域特征 | ~10 | POI相关特征 |
| 市场特征 | ~10-20 | 搜索指数相关特征 |
| 经济特征 | ~8 | 宏观经济指标 |
| 土地交易特征 | ~30+ | 土地交易相关特征 |
| 二手房特征 | ~30+ | 二手房交易相关特征 |
| 邻近区域特征 | ~20+ | 空间相关特征 |
| 交互特征 | ~15 | 特征间交互项 |
| **总计** | **~250+** | **候选特征总数** |
| **选择后** | **~50-100** | **最终特征数量** |

### 特征重要性分布

根据特征选择结果，通常最重要的特征类型包括：
1. 滞后特征（特别是1-3个月的滞后值）
2. 移动平均特征（特别是6-12个月的移动平均）
3. 增长率特征
4. 价格相关比率特征
5. 邻近区域特征

---

## 注意事项

### 1. 数据时间格式
- 确保所有数据文件中的时间列格式一致
- 新房交易数据使用标准日期格式
- 其他数据使用 `YYYY-MMM` 格式（如 `2019-Jan`）

### 2. 内存使用
- 特征工程过程会创建大量中间特征，注意内存使用
- 建议在具有足够内存的环境中运行

### 3. 计算时间
- 完整的特征工程流程可能需要几分钟到十几分钟
- 特征选择阶段（特别是互信息计算）可能较慢

### 4. 特征选择阈值
- 可以根据实际需求调整特征选择阈值
- 在 `feature_selection()` 方法中修改阈值参数

### 5. 缺失值处理
- 确保在特征选择前完成缺失值处理
- 某些特征可能因为缺失值过多而被自动排除

---

## 改进建议

### 未来可能的改进方向

1. **特征工程自动化**
   - 使用AutoML工具自动生成特征
   - 基于领域知识的特征模板

2. **特征重要性可视化**
   - 生成特征重要性图表
   - 特征相关性热力图

3. **特征工程管道化**
   - 使用sklearn Pipeline封装
   - 支持特征工程的保存和加载

4. **更多统计特征**
   - 偏度、峰度等分布特征
   - 自相关特征

5. **深度学习特征**
   - 使用神经网络提取特征
   - 嵌入特征（Embedding Features）

---

## 版本信息

- **版本**: 2.0 (改进版)
- **更新日期**: 2024
- **主要改进**:
  - 新增土地交易特征
  - 新增二手房交易特征
  - 新增邻近区域特征
  - 改进特征选择方法
  - 改进缺失值处理策略

---

## 联系方式

如有问题或建议，请参考项目文档或联系开发团队。

